dependencies:
  build:
    - elixir
    - npm
  runtime:
    - bash
    - curl
    - s6
    - jq
    - ca-certificates
    - bob2cool-github-io-openrc
  trace: true

stack: alpine/3.19

run:
  commands:
    - binary: bob2cool-github-io
      call: eval 'Bob2cool-github-io.Release.Tasks.migrate'
      name: migrate
    - binary: bob2cool-github-io
      call: remote
      name: console
    - binary: tail
      call: -f -n 100 /var/log/bob2cool-github-io/current
      name: logs
      path: /usr/bin
  name: bob2cool-github-io
  services:
    - binary: bob2cool-github-io
      name: web
      start:
        call: start

hook:
  post-deinstall: |
    rc-service bob2cool-github-io stop
    rc-update del bob2cool-github-io
  post-install: |
    rc-update add bob2cool-github-io
    rc-service bob2cool-github-io migrate
  post-upgrade: |
    rc-service bob2cool-github-io migrate
    rc-service bob2cool-github-io start
  pre-upgrade: |
    rc-service bob2cool-github-io stop

build:
  command: |
    export MIX_ENV=prod

    mix local.hex --force
    mix local.rebar --force
    mix do deps.get --only prod

    # npm --prefix ./assets install ./assets

    # Comment out mix assets.deploy for non phoenix apps
    mix assets.deploy

    mix release
  destinations:
    - _build/prod/rel/bob2cool-github-io/*

kits:
  - description: Web service
    main: true
    name: web
    ports:
      - main: true
        name: web
        target: 4000
    variables:
      - default_value: 'true'
        key: PHX_SERVER
      - driver: generic/secret
        driver_options:
          length: 128
        key: SECRET_KEY_BASE
